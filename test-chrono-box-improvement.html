<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chrono Box Improvement Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .chrono-box {
            border: 2px solid #ccc;
            padding: 20px;
            margin: 20px 0;
            min-height: 200px;
        }
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 10px;
            border-radius: 4px;
        }
        .info {
            background: #e3f2fd;
            color: #1565c0;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>Chrono Box Improvement Test</h1>
    
    <div class="info">
        <h3>Improvement Summary</h3>
        <p><strong>Before:</strong> Chrono-box showed a loading circle until the worker determined which fragment to load.</p>
        <p><strong>After:</strong> Chrono-box immediately loads and displays the appropriate fragment based on current time, then starts the worker for subsequent updates.</p>
        <p><strong>Benefit:</strong> No loading circle on page load - content appears immediately.</p>
    </div>

    <div class="chrono-box" id="chrono-box-1">
        <div>Loading chrono-box content...</div>
    </div>

    <div class="success">
        <h4>Test Instructions:</h4>
        <ul>
            <li>Refresh the page to see the immediate loading behavior</li>
            <li>Add <code>?timing=</code> parameter to test different time scenarios</li>
            <li>Example: <code>?timing=1704067200000</code> (Jan 1, 2024)</li>
        </ul>
    </div>

    <script type="module">
        // Mock the required dependencies for demonstration
        const mockDependencies = {
            'https://milo.adobe.com/libs/blocks/fragment/fragment.js': {
                default: async (link) => {
                    // Simulate fragment loading
                    await new Promise(resolve => setTimeout(resolve, 100));
                    link.innerHTML = `<div class="fragment-content">
                        <h3>Fragment Content</h3>
                        <p>This fragment was loaded immediately without showing a loading circle.</p>
                        <p>Current time: ${new Date().toLocaleString()}</p>
                    </div>`;
                }
            },
            'https://milo.adobe.com/libs/utils/utils.js': {
                createTag: (tagName, attributes, content, options) => {
                    const element = document.createElement(tagName);
                    if (attributes) {
                        Object.entries(attributes).forEach(([key, value]) => {
                            element.setAttribute(key, value);
                        });
                    }
                    if (content) {
                        element.textContent = content;
                    }
                    if (options?.parent) {
                        options.parent.appendChild(element);
                    }
                    return element;
                },
                getLocale: () => ({ prefix: '' }),
                getConfig: () => ({ locales: {} })
            },
            'https://milo.adobe.com/libs/features/spectrum-web-components/dist/theme.js': {},
            'https://milo.adobe.com/libs/features/spectrum-web-components/dist/progress-circle.js': {}
        };

        // Mock the import function
        const originalImport = globalThis.import;
        globalThis.import = async (module) => {
            return mockDependencies[module] || {};
        };

        try {
            // Create a test schedule
            const now = Date.now();
            const schedule = [
                {
                    pathToFragment: '/fragment1',
                    toggleTime: now - 2000, // Past
                },
                {
                    pathToFragment: '/fragment2', 
                    toggleTime: now + 5000, // Future
                },
                {
                    pathToFragment: '/fragment3',
                    toggleTime: now + 10000, // Further future
                }
            ];

            // Mock the block config
            const mockBlockConfig = {
                schedule: JSON.stringify(schedule)
            };

            // Import and test the chrono-box
            const { default: init } = await import('./events/blocks/chrono-box/chrono-box.js');
            
            // Mock readBlockConfig
            const originalReadBlockConfig = window.readBlockConfig;
            window.readBlockConfig = () => mockBlockConfig;
            
            // Initialize the chrono-box
            const el = document.getElementById('chrono-box-1');
            await init(el);

        } catch (error) {
            console.error('Test failed:', error);
            document.getElementById('chrono-box-1').innerHTML = `
                <div class="error">
                    <h3>Test Error</h3>
                    <p>${error.message}</p>
                    <p>This is expected in this demo environment since we're not running the full Milo framework.</p>
                </div>
            `;
        } finally {
            // Restore original functions
            globalThis.import = originalImport;
        }
    </script>
</body>
</html> 
